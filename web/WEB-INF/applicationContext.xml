<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<!--
 | Contains the bean definitions and relationships that are avalable
 | to the spring WebApplicationContext
 +-->
<beans>
    <bean id="propertyConfigurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer" lazy-init="false">
        <property name="locations">
            <list>
                <value>/WEB-INF/datasource.properties</value>
            </list>
        </property>
    </bean>
    
    <bean id="HttpManagerBean" class="edu.wisc.my.webproxy.beans.http.HttpManagerImpl" singleton="false" />
    <bean id="HtmlParserBean" class="edu.wisc.my.webproxy.beans.filtering.NekoHtmlParser" singleton="false" />
    
    <bean id="SaxFilterBean" class="edu.wisc.my.webproxy.beans.SpringList" singleton="false">
        <property name="wrappedList">
            <list>
                <!-- The order beans are specified in this list is reversed. The last filter will be the first executed -->
                <ref bean="FuncNameUrlFilter"/>
                <ref bean="PortletURLFilterBean"/>
                <ref bean="AbsoluteUrlFilterBean"/>
                <ref bean="ClippingFilterBean"/>
            </list>
        </property>
    </bean>
    
    <bean id="BaseUrlFilterBean" abstract="true">
        <property name="elements">
            <map>
                <entry key="A">
                    <set>
                        <value>HREF</value>
                    </set>
                </entry>
                <entry key="AREA">
                    <set>
                        <value>HREF</value>
                    </set>
                </entry>
                <entry key="BASE">
                    <set>
                        <value>HREF</value>
                    </set>
                </entry>
                <entry key="LINK">
                    <set>
                        <value>HREF</value>
                    </set>
                </entry>
                <entry key="IMG">
                    <set>
                        <value>SRC</value>
                        <value>LOWSRC</value>
                        <value>USEMAP</value>
                    </set>
                </entry>
                <entry key="EMBED">
                    <set>
                        <value>SRC</value>
                    </set>
                </entry>
                <entry key="FRAME">
                    <set>
                        <value>SRC</value>
                    </set>
                </entry>
                <entry key="SCRIPT">
                    <set>
                        <value>SRC</value>
                    </set>
                </entry>
                <entry key="Q">
                    <set>
                        <value>CITE</value>
                    </set>
                </entry>
                <entry key="INS">
                    <set>
                        <value>CITE</value>
                    </set>
                </entry>
                <entry key="DEL">
                    <set>
                        <value>CITE</value>
                    </set>
                </entry>														
                <entry key="FORM">
                    <set>
                        <value>ACTION</value>
                    </set>
                </entry>
                <entry key="META">
                    <set>
                        <value>URL</value>
                    </set>
                </entry>
                <entry key="BODY">
                    <set>
                        <value>BACKGROUND</value>
                    </set>
                </entry>
                <entry key="APPLET">
                    <set>
                        <value>CODEBASE</value>
                    </set>
                </entry>														
            </map> 
        </property>
    </bean>

    <bean id="FuncNameUrlFilter" parent="BaseUrlFilterBean" class="edu.wisc.my.webproxy.beans.filtering.FuncNameUrlFilter" singleton="false">
    </bean>
    
    <bean id="AbsoluteUrlFilterBean" parent="BaseUrlFilterBean" class="edu.wisc.my.webproxy.beans.filtering.AbsoluteUrlFilter" singleton="false">
    </bean>	

    <bean id="PortletURLFilterBean" parent="BaseUrlFilterBean" class="edu.wisc.my.webproxy.beans.filtering.PortletUrlFilter" singleton="false">
	</bean>
	
    <bean id="ClippingFilterBean" class="edu.wisc.my.webproxy.beans.filtering.ClippingFilter" singleton="false">
        <property name="acceptableQNames">
            <set>
                <value>br</value>
                <value>img</value>
                <value>meta</value>
                <value>link</value>
                <value>input</value>
                <value>col</value>
                <value>b</value>
            </set>
        </property>
    </bean>
    
        
    <bean id="ContentTypeBean" class="edu.wisc.my.webproxy.beans.SpringList" singleton="false">
        <property name="wrappedList">
            <list>
                <value>text/html</value>
                <value>XHTML/1.0</value>
            </list>
        </property>
    </bean>
    
    <bean id="ConfigBean" class="edu.wisc.my.webproxy.beans.SpringList" singleton="false">
        <property name="wrappedList">
            <list>
                <ref bean="GeneralConfigBean"/>
                <ref bean="PageCacheConfigBean"/>
                <ref bean="HttpHeaderConfigBean"/>
                <ref bean="StaticHtmlBean"/>
                <ref bean="HttpClientConfigBean"/>
                <ref bean="ClippingConfigBean"/>
                <ref bean="HTMLParserConfigBean"/>
            </list>
        </property>
    </bean>
    
    
    <bean id="GeneralConfigBean" class="edu.wisc.my.webproxy.beans.config.GeneralConfigImpl" singleton="false">
        <property name="jsp">
            <value>/WEB-INF/jsp/generalConfig.jsp</value>
        </property>
    </bean>
    <bean id="HttpHeaderConfigBean" class="edu.wisc.my.webproxy.beans.config.HttpHeaderConfigImpl" singleton="false">
        <property name="jsp">
            <value>/WEB-INF/jsp/httpHeaderConfig.jsp</value>
        </property>
    </bean>
    <bean id="StaticHtmlBean" class="edu.wisc.my.webproxy.beans.config.StaticHtmlConfigImpl" singleton="false">
        <property name="jsp">
            <value>/WEB-INF/jsp/staticHtmlConfig.jsp</value>
        </property>
    </bean>
    <bean id="HttpClientConfigBean" class="edu.wisc.my.webproxy.beans.config.HttpClientConfigImpl" singleton="false">
        <property name="jsp">
            <value>/WEB-INF/jsp/httpClientConfig.jsp</value>
        </property>
    </bean>
    <bean id="ClippingConfigBean" class="edu.wisc.my.webproxy.beans.config.ClippingConfigImpl" singleton="false">
        <property name="jsp">
            <value>/WEB-INF/jsp/clippingConfig.jsp</value>
        </property>
    </bean>
    <bean id="HTMLParserConfigBean" class="edu.wisc.my.webproxy.beans.config.HtmlParserConfigImpl" singleton="false">
        <property name="jsp">
            <value>/WEB-INF/jsp/htmlParserConfig.jsp</value>
        </property>
    </bean>
    <bean id="PageCacheConfigBean" class="edu.wisc.my.webproxy.beans.config.CacheConfigImpl" singleton="false">
        <property name="jsp">
            <value>/WEB-INF/jsp/cacheConfig.jsp</value>
        </property>
    </bean>
    
    
    <bean id="StateStore" class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
        <property name="transactionManager"><ref bean="transactionManager"/></property>
        <property name="target"><ref local="StateStoreTarget"/></property>
        <property name="transactionAttributes">
            <props>
                <prop key="store*">PROPAGATION_REQUIRED</prop>
                <prop key="delete*">PROPAGATION_REQUIRED</prop>
                <prop key="get*">readOnly</prop>
            </props>
        </property>
    </bean>
    
    <bean id="StateStoreTarget" class="edu.wisc.my.webproxy.beans.http.JdbcStateStore">
        <property name="dataSource"><ref local="dataSource"/></property>
        <property name="lobHandler"><ref local="lobHandler"/></property>
    </bean>
    
    
    <bean id="PageCache" class="edu.wisc.my.webproxy.beans.cache.oscache.OsCachePageCache">
        <property name="cacheProperties">
            <props>
                <prop key="cache.memory">true</prop>
                <prop key="cache.capacity">64</prop>
                <prop key="cache.algorithm">com.opensymphony.oscache.base.algorithm.LRUCache</prop>
                <prop key="cache.blocking">false</prop>
                <prop key="cache.unlimited.disk">false</prop>
                <prop key="cache.persistence.class">edu.wisc.my.webproxy.beans.cache.oscache.SpringLocatingPersistenceListener</prop>
                <prop key="cache.persistence.spring.beanName">filteringPersistenceListener</prop>
            </props>
        </property>
    </bean>
    
    <bean id="filteringPersistenceListener" class="edu.wisc.my.webproxy.beans.cache.oscache.FilteringPersistenceListener">
        <property name="delegateListener"><ref local="hashingPersistenceListener"/></property>
        <property name="persistedGroups">
            <set>
                <value>PERSIST</value>
            </set>
        </property>
    </bean>
    
    <bean id="hashingPersistenceListener" class="edu.wisc.my.webproxy.beans.cache.oscache.KeyHashingPersistenceListener">
        <property name="delegateListener"><ref local="jdbcPersistenceListener"/></property>
    </bean>
    
    
    <bean id="jdbcPersistenceListener" class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
        <property name="transactionManager"><ref bean="transactionManager"/></property>
        <property name="target"><ref local="jdbcPersistenceListenerTarget"/></property>
        <property name="transactionAttributes">
            <props>
                <prop key="clear*">PROPAGATION_REQUIRED</prop>
                <prop key="remove*">PROPAGATION_REQUIRED</prop>
                <prop key="store*">PROPAGATION_REQUIRED</prop>
                <prop key="is*">readOnly</prop>
                <prop key="retrieve*">readOnly</prop>
            </props>
        </property>
    </bean>
    
    <bean id="jdbcPersistenceListenerTarget" class="edu.wisc.my.webproxy.beans.cache.oscache.JdbcPersistenceListener">
        <property name="dataSource"><ref local="dataSource"/></property>
        <property name="lobHandler"><ref local="lobHandler"/></property>
    </bean>
    
    
    
    <bean id="dataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
        <property name="driverClassName"><value>${jdbc.driverClassName}</value></property>
        <property name="url"><value>${jdbc.url}</value></property>
        <property name="username"><value>${jdbc.username}</value></property>
        <property name="password"><value>${jdbc.password}</value></property>
        
        <property name="initialSize"><value>8</value></property>
        <property name="maxActive"><value>128</value></property>
        <property name="maxIdle"><value>16</value></property>
        <property name="minIdle"><value>8</value></property>
        <property name="maxWait"><value>15000</value></property>
    </bean>
    
    <bean id="lobHandler" class="org.springframework.jdbc.support.lob.OracleLobHandler">
        <property name="nativeJdbcExtractor"><ref local="nativeJdbcExtractor"/></property>
    </bean>
    
    <bean id="nativeJdbcExtractor" class="org.springframework.jdbc.support.nativejdbc.CommonsDbcpNativeJdbcExtractor">
    </bean>
    
    <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource"><ref local="dataSource"/></property>
    </bean>
</beans>
